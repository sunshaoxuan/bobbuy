# ARCH-01: 平台技术架构选型

**生效日期**: 2026-01-13
**状态**: 草案
**引用**: [PROD-01-原始需求清单.md](PROD-01-原始需求清单.md)

---

## 1. 总体选型原则
- **高可用性**：支持微服务横向扩展，应对业务增长。
- **强一致性**：金融级支付与订单数据必须保证强一致。
- **AI 友好性**：后端架构需支持与 Python 生态（AI 模型常用语言）的平滑对接。

## 2. 后端架构：Spring Cloud 生态
采用 **Spring Cloud Alibaba** 作为核心套件，提供微服务治理。

- **核心框架**：Spring Boot 3.x
- **服务治理**：Nacos (注册中心 + 配置中心)
- **网关层**：Spring Cloud Gateway (承担限流、统一鉴权、日志切面)
- **服务调用**：OpenFeign + Sentinel (断路器与流量防护)
- **分布式事务**：Seata (针对跨服务的订单与结算一致性)

### 2.1 AI 与 Python 服务集成
由于 AI 能力（LLM 调度、OCR、图像搜索）在 Python 下实现更为高效，建议：
- **方案**：使用 **FastAPI** 编写 AI 侧微服务，通过 **Spring Cloud Sidecar** 或直接基于独立微服务注册至 Nacos 进行 Feign 调用。

## 3. 前端架构：React + Ant Design
- **核心框架**：React 18+ (使用 Functional Components + Hooks)
- **UI 组件库**：Ant Design 5.x (最新版本，提供流畅的 B 端/C 端交互)
- **状态管理**：Zustand 或 Redux Toolkit (根据复杂程度选型)
- **跨平台**：
  - Web 面向 PC 段。
  - **移动端**：使用 Ant Design Mobile 或基于 React Native 封装，确保手机端紧凑、易用的触控体验。

## 4. 数据存储与持久化

### 4.1 关系型与半结构化数据：PostgreSQL
- **核心优势**：原生支持 `JSONB` 类型，完美契合 IM 聊天记录及动态商品属性的存储。
- **扩展性**：支持存储过程及高级查询，可作为任务排队的基础存储方案。

### 4.2 对象存储：MinIO
- **用途**：存储原始聊天截图、采购账单原图、商品官方大图。
- **优势**：S3 协议兼容，支持私有化部署，数据安全可控。

## 5. 中间件与并发控制

### 5.1 缓存与状态管理：Redis
- **用途**：IM 消息实时推送掩码、用户 Session、高频商品缓存。
- **高级用法**：使用 **Redisson** 实现分布式锁，控制多商家抢单或库存扣减。

### 5.2 异步消息与任务队列：Apache Kafka (核心选型)
- **开源说明**：RabbitMQ 与 Kafka 均为成熟的开源免费方案。
- **选型决策**：采用 **Apache Kafka**。
- **理由**：相比 RabbitMQ，Kafka 的底层设计（顺序读写磁盘、零拷贝技术）拥有更高的吞吐量和更强的持久化能力。
  - **高并发支撑**：作为全球委托任务平台，未来的 IM 消息流和 AI 行为日志可能达到海量规模，Kafka 的分布式分区架构能提供极强的横向扩展能力。
  - **数据回溯**：Kafka 的日志持久化特性允许我们在 AI 解析出现偏差时，重新拉取历史消息流进行回测与训练。
- **用途**：
  - IM 消息分发与削峰。
  - AI 密集型任务（OCR、语义解析）的分布式异步处理本地或集群部署。
  - 系统核心业务审计流存储。

### 5.3 验证网关 (Verification Gateway)
- **需求来源**：依据 [ARCH-04](ARCH-04-客户快速创建与管理详细设计.md)，敏感信息修改需强验证。
- **选型建议**：
  - **国内/国际短信/语音组件**：预留接口对接主流云通讯服务商。
  - **邮件服务**：后端集成邮件发送能力（如 AWS SES 或 SMTP 服务）。
- **职责**：生成并校验多维度验证码，确保存储数据的真实性。

### 5.4 聚合支付集成层 (Payment Service Library)
- **职责**：封装各支付渠道（Paypay, LinePay, Stripe, WeChat/Alipay）的 SDK 差异。
- **选型建议**：后端采用**工厂模式**解耦，前端通过统一的支付组件唤起原生或 H5 支付界面。
- **安全要求**：支持 PCI-DSS 合规性预留，敏感数据透传必须经过加密处理。

## 6. 开发质量与合规性 (STD 联动)
- 所有后端代码遵循 **STD-03-通用编程规范**。
- API 定义遵循 **STD-04-API 接口设计规范**。
- 数据库表设计遵循 **STD-05-数据库设计规范**，严禁使用存储过程处理核心业务逻辑，坚持逻辑抽象（Logic Schema）。

## 7. 部署与运维
- **容器化**：Docker + Kubernetes (K8s) 声明式部署。
- **CI/CD (定型)**：使用 **GitHub Actions** 自动化流水线。
  - **静态检查**：代码规范检测（Lint）。
  - **构建验证**：后端 Maven/Gradle 构建，前端 NPM 构建。
  - **集成测试**：自动运行核心业务流程测试。
