# ARCH-02: 订单确认模块详细设计

**生效日期**: 2026-01-13
**状态**: 草案
**引用**: [PROD-02-业务功能详细说明.md](PROD-02-业务功能详细说明.md)

---

## 1. 模块概述
订单确认是连接客户原始需求与平台标准化订单的关键环节。通过 AI 技术对非结构化的 IM 聊天记录进行实时解析，形成商客双方可感知的预购清单，并支持商家对商品信息的深度补全与可见性控制。

## 2. 需求捕获与 Agent 审计 (Inbound & Auditing)
### 2.1 语义解析 Agent (Parsing Agent)
-   **输入处理**：接收客户端发送的多语种混杂语音或文字（如：中日混合需求）。
-   **工作流**：
    -   **Step 1析 (Parser)**：提取商品名、规格（如 2kg）、数量（如 最少2箱）、优先级（如 能抢到的话）。
    -   **Step 2审计 (Auditor)**：Agent 驱动另一个独立模型实例对解析出的 JSON 进行合法性与逻辑复核，确保关键约束（如“最少2箱”）不被遗漏。

### 2.2 格式化输出
-   解析后的数据通过 **Formatting Agent** 转化为标准结构化清单，返回至商家工作台供初步确认。

## 3. 智能商品匹配与知识闭环
### 3.1 本地库匹配 (Semantic Matching)
-   **语义关联**：即使客户描述与库内名称不完全一致（如“马粪蛋糕”对应库内“Muffin”），AI 也会根据上下文和历史轨迹进行关联（详见 3.4 经验库）。
-   **物料自动关联**：匹配成功后自动拉取库内已有的图片、SKU 编号及官方价格。
-   **商家干预**：商家快速勾选每件商品的“图片可见性”，确定是否向客户推送该图片。

### 3.2 外部搜索 Agent (Search Agent)
-   **未知捕获**：对于本地库无法匹配的商品，启动 **Search Agent** 调用 Google/Apple 等接口进行全网补完信息。
-   **二次确认**：搜索结果回传后再次与本地库进行语义对撞，防止重复录入。

### 3.3 意向商品暂存库 (Transient Store)
-   **挂起机制**：搜索后仍无法 100% 确认的商品进入“意向暂存库”，暂不进入正式 SKU 库。
-   **现场核销**：当商家在卖场通过 [ARCH-05](ARCH-05-采购执行与商品采集详细设计.md) 发现实物并拍照入库后，AI 自动核销“暂存库需求”，实现从“意向”到“实物”的闭环转换。

### 3.4 积累与复用：经验库 (Experience Bank)
-   **经验库构建**：记录“模糊描述 -> 最终确认产品”的映射链条。
-   **能力进化**：随着交易频次增加，AI 学习并归纳商家的操作习惯（如固定品牌映射），实现后续匹配的指数级加速。

## 4. 操作流程与 UI 设计

### 4.1 手机端 (Mobile-First)
-   **交互原则**：紧凑但不拥挤，操作区域易于点击。
-   **界面布局**：
    -   **双窗格模型**：上方或左侧为聊天记录粘贴/读取窗口；下方或右侧为实时生成的“预购清单”。
    -   **视图切换**：
        -   **列表视图**：小图、突出显示品名、规格、数量（适用于快速核对）。
        -   **画廊视图**：大图预览，下方展示详细参数（适用于精细信息补全）。
-   **可见性开关**：每个商品条目旁设有“客户可见”拨动开关。

### 4.2 Web 端
-   **交互原则**：专业、美观、高效率。
-   **界面布局**：采用左右分屏布局，左侧为全文聊天回溯，右侧为带有多tab的商品编辑表单。

## 5. 数据入口与处理逻辑

### 5.1 数据输入 (Data Input)
1.  **手动粘贴**：用户将微信、Line 等 App 中的聊天记录复制并粘贴至输入框。
2.  **IM 接口对接 (调查建议)**：
    -   **Line**：利用 Messaging API 的 Webhook，可实时接收并处理用户发送的消息。
    -   **微信**：服务号/小程序可通过 Webhook 接收消息；个人号需通过辅助工具或提醒用户粘贴。
    -   **同步策略**：系统实时监听粘贴动作或 Webhook 回调，触发 AI 分析。

### 5.2 AI 分析引擎
1.  **模型选型**：
    -   推荐使用 **LLM (如 GPT-4o 或 Claude 3.5)** 进行语义提取。由于代购语言描述极其模糊（例如“上次那个红色的坚果”），小模型往往难以处理上下文关联。
2.  **处理规则**：
    -   **第一轮提取**：从文本中提取品名、规格关键词、数量倾向。
    -   **商品库匹配**：优先检索内部商品库，完全匹配的直接标记为“已入库”。
    -   **外部智能搜素**：
        -   **目标**：无匹配时，调用搜索接口（Google Search API、零售商官网等）。
        -   **采集内容**：商品官方名称、官方大图、详细规格说明、官方商品编号或 UPC 码。
    -   **入库准则**：
        -   **明确匹配**：AI 分析搜索结果确认为该卖场产品的，进入临时商品条目。
        -   **模糊匹配**：AI 无法定位到具体产品的，写入“待选清单”，由商家手动干预。

## 7. Agent 可靠性与确定性保证 (Reliability)

### 7.1 原子化状态转换 (Atomic State Transition)
- **意向到正式**：当商家在卖场确认暂存商品时，系统必须确保“意向条目删除”与“正式 SKU 创建/关联”在同一个事务内完成，防止商品在核销过程中丢失。

### 7.2 审计轨迹 (Audit Trail)
- **决策回溯**：系统记录 Agent 处理该条需求的完整逻辑链（Thought Process）。
- **版本比对**：保留 Parsing Agent 产生的第一个版本与 Audit Agent 审计后的最终版本，用于离线准确率分析（Token 审计）。

### 7.3 错误退避与重试 (Retry Policy)
- **语义冲突处理**：当 Audit Agent 指出逻辑冲突且重试 3 次仍未收敛时，系统必须停止自动处理，并将该项标记为“由 AI 标记为歧义 (AI-Disputed)”，强制推送到商家工作台进行人工仲裁。

### 7.4 经验库收敛性校验
- **学习验证**：人工干预后的结果强制存入向量经验库。下次相同输入必须经过经验库先验增强（Prior Enhancement），确保系统“不掉入同一个坑两次”。
-   **生命周期控制**：从预购清单生成到最终送货完毕前，商家拥有最高修改权限。包含：
    -   修改单价、数量。
    -   替换产品图。
    -   补充/修改商品编码。
-   **价格歧视与隐私保护**：
    -   **默认状态**：所有外部搜索来的图片 and 价格对客户 **默认关闭**。
    -   **显式授权**：商家必须明确点击“授权可见”按钮，客户才能在其端看到相关图片详细信息。
    -   **价格隔离**：商家可以看到采购成本价与代购价，客户仅可见商家设定的最终代购价。

## 5. 数据出口与订单成立
-   **出口 1 (客户确认流)**：导出一张包含“商家授权图片+客户原始文字+最终确认规格+价格”的确认卡片至 IM 对话。
-   **出口 2 (系统订单流)**：将确认后的预购清单持久化为正式订单，触发库存（如有）与财务流水。

## 6. 技术要点
-   **搜索 API**：Google Custom Search API 或特定的电商爬行器。
-   **前端响应**：使用 WebSocket 确保“边粘边解析”的实时反馈感。
-   **图像托管**：官方大图需抓取并存储于私有 OSS，防止外部链接失效。
