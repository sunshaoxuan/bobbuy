---
引用: PROD-02-业务功能详细说明
状态: 草案
生效日期: 2026-01-13
---

# ARCH-06: 最终结账与线下结算详细设计

## 1. 模块概述
本模块负责采购完成后的财务闭环。通过多模态 AI 代理对采购小票进行结构化核销，生成正式账单，并支持灵活的长效线下支付与差额管理机制。

## 2. AI 小票识别流水线 (Receipt Analysis)
由于小票可能极长且包含复杂分级，系统建议采用 **多模态大模型 (MLLM) + 分片合并 Agent** 方案：
-   **多图输入**：支持商家上传多张连续拍摄的小票照片。
-   **提取内容**：商品名称/代码、SKU 数量、单价、税费、折扣额、合计总额、付款方式。
-   **Agent 职责**：负责图片间的重叠部分去重，并计算逻辑总和以校验单据完整性。

## 3. 订单核销四象限逻辑 (Reconciliation Matrix)
将识别后的“实采清单”与系统的“预定订单”进行全自动对比，处理四类差异：

| 场景 | 匹配特征 | 处理逻辑 |
| :--- | :--- | :--- |
| **1. 完全匹配** | 预定中有，小票中也有 | 按实际采购数量自动填入订单。 |
| **2. 订单遗漏** | 预定中有，小票中没有 | **系统强提醒**：商家需确认是“确认缺货”还是“忘记采买”。 |
| **3. 现场补货** | 预定中无，小票中有 | **商家指认**：手动将其关联至特定客户，系统自动在客户清单中补录该商品。 |
| **4. 复核发布** | 所有项目对比完成 | 商家逐项核准单价、图片可见性，点击“发布核销”。 |

## 4. 账单生成与分发机制
### 4.1 确认单格式
核销后，系统自动聚合商品费用与 [ARCH-05](ARCH-05-行程发布与费用定价详细设计.md) 计算的各类附加费，支持生成：
-   **图片格式**：仿零售商小票样式的汇总长图。
-   **结构化文本**：便于 IM 复制。
-   **PDF**：正式的采购凭证。

### 4.2 确认触发
商家点击“发送确认”后，系统通过 IM 接口将账单分发给对应客户。

## 5. 线下结算与差额重抵模型
平台现阶段主打线下现金收款，需处理复杂的非标准化支付场景：
-   **支付录入**：商家手动在列表中更新每个客户的“已付金额”。
-   **分单与多方式支付**：支持为同一笔结账记录多条流水（如：1000现金+500转账）。
-   **差额冲抵 (Account Balance)**：
    -   **溢价/多付**：记录为“下次充抵 (+余额)”。
    -   **欠款/少付**：记录为“下次充抵 (-余额)”。
    -   **流程**：下次结账时，系统自动遍历余额记录并参与结算公式计算。
-   **找零记录**：支持记录零钱支付（负向流水），由商家决定是否导出至流水。

## 6. 技术实现要点
-   **核销引擎**：基于实采快照与预定快照的 Diff 算法。
-   **支付状态机**：`待支付 -> 部分支付 -> 已结清 / 已冲抵`。
-   **差额持久化**：在客户档案 (Profile) 中维护独立的 `BalanceAccount` 实体。
