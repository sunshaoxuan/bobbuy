---
引用: PROD-02-业务功能详细说明
状态: 草案
生效日期: 2026-01-13
---

# ARCH-06: 最终结账与线下结算详细设计

## 1. 模块概述
本模块负责采购完成后的财务闭环。通过多模态 AI 代理对采购小票进行结构化核销，生成正式账单，并支持灵活的长效线下支付与差额管理机制。

## 2. AI 小票识别流水线 (Receipt Analysis)
由于小票可能极长且包含复杂分级，系统建议采用 **多模态大模型 (MLLM) + 分片合并 Agent** 方案：
-   **多图输入**：支持商家上传多张连续拍摄的小票照片。
-   **提取内容**：商品名称/代码、SKU 数量、单价、税费、折扣额、合计总额、付款方式。
-   **Agent 职责**：负责图片间的重叠部分去重，并计算逻辑总和以校验单据完整性。

## 3. 订单核销四象限逻辑 (Reconciliation Matrix)
将识别后的“实采清单”与系统的“预定订单”进行全自动对比，处理四类差异：

| 场景 | 匹配特征 | 处理逻辑 |
| :--- | :--- | :--- |
| **1. 完全匹配** | 预定中有，小票中也有 | 按实际采购数量自动填入订单。 |
| **2. 订单遗漏** | 预定中有，小票中没有 | **系统强提醒**：商家需确认是“确认缺货”还是“忘记采买”。 |
| **3. 现场补货** | 预定中无，小票中有 | **商家指认**：手动将其关联至特定客户，系统自动在客户清单中补录该商品。 |
| **4. 未核销/自购** | 小票中有，但无法指认给任何客户 | **自购归类**：商家手动将其标记为“自购/个人使用”，系统自动将其成本从经营成本中剥离（详见 [ARCH-07](ARCH-07-利润核算与经营分析详细设计.md)）。 |
| **5. 复核发布** | 所有项目对比完成 | 商家逐项核准单价、图片可见性，点击“发布核销”。 |

## 4. 账单生成与分发机制
### 4.1 确认单格式
核销后，系统自动聚合商品费用与 [ARCH-03](ARCH-03-行程发布与费用定价详细设计.md) 计算的各类附加费，支持生成：
-   **图片格式**：仿零售商小票样式的汇总长图。
-   **结构化文本**：便于 IM 复制。
-   **PDF**：正式的采购凭证。

### 4.2 确认触发
商家点击“发送确认”后，系统通过 IM 接口将账单分发给对应客户。

## 5. 线下结算与差额重抵模型
平台现阶段主打线下现金收款，需处理复杂的非标准化支付场景：
-   **支付录入**：商家手动在列表中更新每个客户的“已付金额”。
-   **分单与多方式支付**：支持为同一笔结账记录多条流水（如：1000现金+500转账）。
-   **差额冲抵 (Account Balance)**：
    -   **溢价/多付**：记录为“下次充抵 (+余额)”。
    -   **欠款/少付**：记录为“下次充抵 (-余额)”。
    -   **流程**：下次结账时，系统自动遍历余额记录并参与结算公式计算。
### 5.2 在线支付网关预留 (Payment Gateway Hub)
虽然当前主打线下结算，但系统已从架构层面预留了**聚合支付网关**，以支持未来逐步接入的各类在线渠道：

-   **支付网关接口定义**：抽象出 `IPaymentProvider` 接口，定义 `CreatePayment` / `Refund` / `QueryStatus` 等标准方法。
-   **预留渠道清单**：
    -   **日本及本地区域**：PayPay, LinePay, 信用卡 (Visa/Master/JCB)。
    -   **移动原生**：Apple Pay, Google Pay。
    -   **跨国支撑**：微信支付 (WeChat Pay), 支付宝 (Alipay)。
-   **流程流转**：
    -   商家点击“发起在线支付” -> 系统生成支付 Token -> 客户 App 唤起相应支付组件 -> 支付结果通过 Webhook 回调系统自动关闭订单。

### 5.3 拣货分拣确认 (Picking & Sorting Check-off)
在最终完成账单确认并准备交付前，系统提供**拣货模式**：
-   **作业场景**：商家在结账后对一大堆商品进行分拣分装。
-   **分拣清单**：按客户维度展示其最终确认的所有商品项。
-   **逐一确认**：商家每分拣出一个客户的包裹，需对订单内产品进行一一打勾确认。
-   **漏送防御**：只有当所有项目均完成打勾后，订单才被标记为“准备好交付”，从而杜绝漏送。

### 5.4 闲置商品与自购处理 (Self-purchase Handling)
-   **定义**：指那些已进入小票实采，但在分拣阶段无法匹配至预定订单，且不属于任何现场客户补货的商品。
-   **手动归类**：系统在核销界面提供“转为自购”按钮。
-   **库存影响**：自购商品不进入订单系统，不会生成客户账单，但会进入商家的个人采买历史。
-   **财务对冲**：自购商品的原始采购成本将从该次行程的“代购经营成本”中自动扣除。

## 6. 技术实现要点
-   **核销引擎**：基于实采快照与预定快照的 Diff 算法。
-   **支付状态机**：`待支付 -> 部分支付 -> 已结清 / 已冲抵`。
-   **差额持久化**：在客户档案 (Profile) 中维护独立的 `BalanceAccount` 实体。
