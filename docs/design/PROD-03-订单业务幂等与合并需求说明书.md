# PROD-03: 订单业务幂等与合并需求说明书

**生效日期**: 2026-01-17  
**状态**: 待评审  
**引用**: [PROD-02-业务功能详细说明.md](PROD-02-业务功能详细说明.md)

---

## 1. 业务目标
代购场景中，客户可能在同一购买事件（Event）中分批次告知需求。为了提升商家处理效率并降低支付链路压力，系统需具备“按事件归口、按规格合并”的自动化能力。

## 2. 核心业务主键定义
系统需识别一次“购买事件”。
- **构成**: `客户唯一标识` + `事件编号`（日期+流水号）。
- **示例**: `CUST_1001_202601170001`。
- **业务语义**: 无论该事件下发起多少次网络请求，对应的底层业务订单头必须唯一。

## 3. 商品逻辑合并规则
在同一“购买事件”下，追加购买同一商品时：

### 3.1 自动累加规则 (Auto-Aggregation)
- **触发条件**: 商品 ID（SKU）相同 **且** 规格（Spec）**完全一致**。
- **行为**: 新旧数量合并，总金额重新核算。
- **典型场景**: 标准化包装品（如：KitKat 巧克力 500g）。

### 3.2 逻辑隔离规则 (Logic Isolation)
- **触发条件**: 商品 ID 相同，但规格（Spec）**不一致**。
- **行为**: 视为不同订单行，物理隔离存放。
- **典型场景**: 
  - **按重计费品**: 同款肉类，一盒 500g，一盒 520g（Spec 分别标注重量）。
  - **个性化选品**: 同款鞋，一双 42 码，一双 43 码。

## 4. 业务完整性约束
- **订单头完整性**: 支付/结算必须以订单头为最小颗粒度。
- **幂等防护**: 在网络重试或用户快速连点场景下，严禁产生重复的业务成交记录。

---
**核准**: Product Owner  
**存档**: docs/design/PROD-03.md
