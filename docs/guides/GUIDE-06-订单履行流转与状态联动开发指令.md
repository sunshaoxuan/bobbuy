# GUIDE-06: 订单履行流转与状态联动开发指令

## 1. 核心任务说明

在完成层级化模型（1:N:N）重构后，下一步需要打通**订单生命周期**与**行程资源**的闭环。程序员需要实现以下核心逻辑：

### 1.1 状态与容量联动 (Automated Capacity)
- **触发时机**: 当 `OrderHeader` 状态转为 `CONFIRMED` 或更高时，必须确保其商品总量已计入 `Trip.reservedCapacity`。
- **合并规则**: 如果是幂等合并（追加订单量），需同步增加 Trip 的占位，若余额不足应抛出 `CAPACITY_NOT_ENOUGH`。

### 1.2 批量履行操作 (Batch Processing)
- **后端接口**: 
  - `PATCH /api/trips/{tripId}/orders/bulk-status`
  - 参数：`targetStatus` (例如: `PURCHASED`)。
  - 行为：将该行程下所有符合流转条件的订单一键更新，并记录审计日志。
- **前端 UI**:
  - 在 `Orders.tsx` 的行程详情区域增加 `ActionGroup`。
  - 包含按钮：“一键确认全部”、“一键标记已采购”、“一键标记已交付”。

### 1.3 交互约束 (Interaction Constraints)
- **只读状态**: `SETTLED` (已结算) 状态的订单头及行数据在 UI 上必须锁定（禁止修改数量或删除行）。
- **回滚逻辑**: 暂不实现状态回滚功能，仅支持正向流转。

## 2. 技术约束

- **合规性**: 严禁直接修改数据库/内存 Map，必须通过 `BobbuyStore` 的封装方法。
- **健壮性**: 批量操作需考虑部分失败的情况，建议使用原子性更新或在循环中捕获单单错误。
- **测试要求**: 
  - 单元测试：验证状态流转触发容量变动的逻辑。
  - 集成测试：模拟一键更新行程下 10 个订单的状态。

## 3. 关联参考

- 业务需求：[PROD-03](../requirements/PROD-03-%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1%E5%B9%82%E7%AD%89%E4%B8%8E%E5%90%88%E5%B9%B6%E9%9C%80%E6%B1%82%E8%AF%B6%E7%BB%86%E8%A7%84%E6%A0%BC%E8%AF%B4%E6%98%8E%E4%B9%A6.md)
- 实施方案：[PLAN-06](../plans/PLAN-06-%E8%AE%A2%E5%8D%95%E9%87%8D%E6%9E%84%E5%AE%9E%E6%96%BD%E6%96%B9%E6%A1%88.md)
