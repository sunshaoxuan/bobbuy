# PLAN-04: Sprint 3 业务链路闭环与 E2E 自动化计划

**制定日期**: 2026-01-16  
**状态**: 待执行  
**目标**: 实现核心代购链路 100% 自动化验收，清偿全部 P1 级技术债务。

---

## 1. 核心任务矩阵 (Sprint 3 Focus)

| 领域 | 任务内容 | 优先级 | 预期产出 |
| :--- | :--- | :--- | :--- |
| **测试** | **Playwright E2E 自动化** | **P0** | 覆盖“发布行程 -> 确认订单 -> 状态流转 -> 结算”全链路。 |
| **后端** | **Controller 专项集成测试** | **P1** | 补齐 `OrderController` 测试，整体行覆盖率冲刺 60%+。 |
| **观测** | **API 日志规范化** | **P1** | 统一输出 `trace_id`, `user_id`, `cost_ms` 等核心字段。 |
| **前端** | **Trips 组件测试补齐** | **P1** | 针对新版行程流转 UI 创建 `Trips.test.tsx`。 |

---

## 2. 细节设计与红线要求

### 2.1 E2E 链路红线 (Playwright)
**文件目录**: `e2e/test_shopping_flow.spec.ts`  
**场景要求**:
- 自动拉起前端并登录。
- 执行完整的代购闭环。
- **强制断言**: 每一个状态 PATCH 动作后，必须检查 Audit Log 接口是否有对应记录。

### 2.2 API 日志规范化 (`STD-04` 对齐)
**实施位置**: `backend/src/main/java/com/bobbuy/api/response/GlobalExceptionHandler.java`  
以及具体的控制器入口。
- **统一格式**: `[INFO] {method} {url} status={code} cost={ms} user={id}`.

### 2.3 设计评审与文档落地
- [x] 更新 `DOCS-01` API 文档至最新 Patch 版本。
- [ ] 编写 `GUIDE-03-自动化测试运行指南.md`。

---

## 3. 分阶段实施排期

### 第一阶段 (周一-周二): 集成测试与日志
- [ ] 后端 Controller 测试补齐。
- [ ] 全局请求拦截器/日志格式化实现。

### 第二阶段 (周三-周四): E2E 攻坚
- [ ] Playwright 环境搭建。
- [ ] 编写核心业务流演练脚本。

---

## 4. 验收标准
- [ ] **E2E 通过率**: 100%。
- [ ] **后端覆盖率**: `BobbuyStore` ≥ 60%, `OrderController` ≥ 50%。
- [ ] **前端覆盖率**: 全系主要 Page 组件 ≥ 70%。

---

**负责人**: 全栈团队  
**截止日期**: 2026-01-23
