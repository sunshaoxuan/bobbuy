# PROD-03: 订单业务幂等与合并需求详细规格说明书

**生效日期**: 2026-01-17  
**状态**: 待评审  
**引用**: [PROD-01-原始需求清单.md](PROD-01-原始需求清单.md)

---

## 1. 业务背景与目标
在代购实际作业中，客户往往通过碎片化的消息发送购买意愿。系统必须支持将属于“同一次劳务事件”的行为进行聚合，以实现财务结算的清晰度。

## 2. 数据层级结构 (Hierarchical Structure)
- **层级关系**: 1 行程 (Trip) : N 订单头 (Order Header) : N 订单行 (Order Line)。
- **业务语义**:
  - **行程 (Trip)**: 商家的一次完整的外出劳务活动。
  - **订单头 (Order Header)**: 归属于某一特定客户在本次行程中的总单据。
  - **订单行 (Order Line)**: 该客户订单下的具体商品细项。

## 3. 功能需求 (Functional Requirements)

### 3.1 业务主键标识 (Idempotent Key)
- **需求描述**: 每一个订单必须具备一个“业务唯一编号”，由客户与商家在协议达成时共同感知。
- **业务规则**: 
  - 该编号在订单生命周期内唯一。
  - 重复提交相同编号的订单，系统应视为对现有订单的追加，而非产生新订单。

### 3.2 订单合并算法 (Merging Rules)
- **场景 A：合并累加**
  - **触发规则**: 同一业务编号下，商品名称、单价、币种完全一致。
  - **业务行为**: 系统自动将新购数量累加至原有条目。
- **场景 B：物理隔离**
  - **触发规则**: 商品名称相同，但其规格属性（如：重量、成色）存在差异。
  - **业务行为**: 必须作为独立行项目呈现。
  - **典型用例**: 超市代购肉类，两盒品名相同但重量不同（480g vs 510g）。

## 4. 非功能需求 (Non-Functional Requirements)

### 4.1 业务响应一致性
- 在前端防抖失效或网络重试场景下，后台必须保证最终业务单据与客户意愿 100% 对齐。

### 4.2 UI 状态反馈
- 提交过程中，界面应展示明确的“处理中”状态，并在合并成功后通过差异化提示（如：数量已更新）告知用户。

---
**核准**: Product Owner  
**存档**: docs/requirements/PROD-03-订单业务幂等与合并需求详细规格说明书.md
