# TC-ORDER-001: 多语需求智能 Agent 全链路严苛验证用例

## 1. 测试背景与目标
本用例旨在跳出“端到端结果匹配”的局限制，转而验证 AI Agent 系统在处理复杂、模糊需求时的 **内部决策链正确性**、**搜索补全能力**、**暂存核销一致性** 以及 **经验库的定向进化能力**。

## 2. 严苛验证维度 (Verification Matrix)

| 阶段 | 验证点 (Checkpoint) | 验证方法 / 严苛准则 |
| :--- | :--- | :--- |
| **1. 需求捕获 (Capture)** | 解析完整性 | **多模型审计**：Parsing Agent 输出后，审计 Agent 必须检测出“最少2箱”这一约束。若审计后 JSON 无此约束，判定为失败。 |
|  | Token 成本/效率比 | 记录双步审计的 Token 消耗，验证是否在预设预算内（防止无限循环）。 |
| **2. 语义匹配 (Matching)** | 语义映射准确度 | **模糊匹配校验**：验证“马粪蛋糕”是否能通过向量库关联至 "Muffin"，且相似度阈值需 > 0.85。 |
|  | 资产可见性控制 | 验证输出给客户端的清单中，商家选定的“非可见图片”必须被严格过滤。 |
| **3. 深度搜索 (Deep Search)** | Agent 触发逻辑 | **未知项感知**：对于“業務用冷冻草莓”，验证 Search Agent 是否被成功唤起。 |
|  | 外部元数据丰富度 | 验证搜集到的 Google 结果是否包含：包装规格、参考单价、图片 URL。 |
| **4. 状态流转 (Workflow)** | 暂存库原子性 | **暂存状态切换**：验证在商家未在现场确认前，该商品 ID 处于 `TRANSIENT` 状态，不具备分拣权限。 |
|  | 现场核销一致性 | 场景模拟：商家拍摄实物照片入库。验证：暂存项已删除且正式 SKU 已创建，两步操作必须在同一事务记录中。 |
| **5. 经验进化 (Learning)** | 经验闭环有效性 | **收敛性测试**：执行完本用例后，再次输入相同文本。验证：匹配步长应从“搜索+暂存”缩短为“本地经验库直接命中”，且延迟缩短 > 50%。 |

## 3. 测试场景演练 (Scenario Scenario)
> **测试负荷 (Test Payload)**: 
> "我想买车厘子，箱子装的2公斤的，能抢到的话最少2箱。还有Cheese cake，还有绿茶口味的马粪蛋糕，另外还有Tomato，ほれんそ和業務用冷冻草莓一袋。"

### 3.1 Step-by-Step 验证审计表
1.  **AI 解析执行**：
    -   [ ] 执行 Parsing Agent
    -   [ ] 执行 Audit Agent (通过双重审查捕获“最少2箱”)
2.  **商品库对撞**：
    -   [ ] 语义匹配：车厘子 -> (Matches) -> Cherry
    -   [ ] 语义联想：马粪蛋糕 -> (Matches) -> Muffin (Match Score: 0.92)
3.  **Agent 搜索流**：
    -   [ ] 触发搜索：業務用冷冻草莓 (Google Search Agent Call)
    -   [ ] 结果存储：创建暂存记录 `T-001: 业务用冷冻草莓`
4.  **实物映射演练**：
    -   [ ] 商家动作：现场拍照并在 App 点击“核销暂存项”
    -   [ ] DB 检查：`T-001` 是否消失？正式 SKU 是否已绑定该需求关系？
5.  **经验固化校验**：
    -   [ ] 检查 Vector DB 是否新增 `马粪蛋糕 -> Muffin` 的索引。

## 4. 异常边界 (Edge Cases)
-   **搜索无果**：如果 Google 搜索不到“業務用冷冻草莓”，Agent 是否会退而求其次仅保留原始文字描述并标记其为“由商家手动寻找”？
-   **审计冲突**：模型 A 解析出 2 箱，模型 B 解析出 3 箱时，是否成功触发了“人工仲裁”流程？

## 5. 评价标准
-   **PASS**: 全链路每个 Checkpoint 均符合验证方法。
-   **FAIL**: 任何一处涉及“状态转换”或“约束捕捉”的漏项，即使最终结果看似正确，也判定为不通过。
